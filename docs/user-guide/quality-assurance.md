# Quality Assurance with RasCheck

!!! warning "Unofficial Implementation"
    RasCheck is an **unofficial** Python implementation based on the FEMA cHECk-RAS tool.
    It is part of the ras-commander library and is **not affiliated with or endorsed by FEMA**.
    Results should be independently verified for official submissions.

## Attribution

!!! info "Based on FEMA cHECk-RAS"
    This module implements the validation checks described in FEMA's
    [cHECk-RAS](https://www.fema.gov/flood-maps/tutorials/check-ras) quality assurance tool
    for HEC-RAS 6.x models, using ras-commander's HDF function library.

    From FEMA's cHECk-RAS page:

    > *"cHECk-RAS utilizes information generated by HEC-RAS (all versions through the latest
    > version, 5.0.7). Note, cHECk-RAS is not compatible with the two-dimensional component
    > of HEC-RAS 5.0.7."*

    This Python implementation extends these validation checks to work with modern HEC-RAS 6.x
    HDF-based outputs, providing equivalent functionality through the ras-commander library.

!!! warning "For Informational Purposes Only"
    Outputs from this library are for **informational purposes only** and should be
    validated by a qualified engineer. This tool does not replace professional engineering
    judgment or official FEMA review processes.

## Overview

RasCheck provides automated quality assurance validation for HEC-RAS 6.x **steady flow** models. It performs comprehensive checks based on FEMA guidelines, HEC-RAS best practices, and the original cHECk-RAS methodology.

### Key Features

- **Automated validation** of Manning's n values, transition coefficients, and cross sections
- **Structure checks** for bridges, culverts, and inline weirs
- **Floodway analysis** validation with state-specific surcharge limits
- **Multiple profile comparison** for discharge ordering and WSE consistency
- **HTML report generation** with detailed messages and recommendations
- **Customizable thresholds** for project-specific requirements

## Quick Start

```python
from ras_commander import init_ras_project, RasPrj
from ras_commander.check import RasCheck, RasCheckReport, ReportMetadata

# Initialize project
ras = RasPrj()
init_ras_project(r"C:\Projects\MyRAS", "6.6", ras_object=ras)

# Run all checks on a plan
results = RasCheck.run_all(
    plan="01",
    profiles=['10yr', '50yr', '100yr', 'Floodway'],
    floodway_profile='Floodway',
    surcharge=1.0,
    ras_object=ras
)

# View summary
print(f"Errors: {results.get_error_count()}")
print(f"Warnings: {results.get_warning_count()}")

# Generate HTML report
results.to_html("validation_report.html")
```

## Check Categories

RasCheck performs five main categories of validation:

| Check Type | Description | Key Validations |
|------------|-------------|-----------------|
| **NT Check** | Manning's n and Transitions | Roughness ranges, transition coefficients, n-value variation |
| **XS Check** | Cross Section Validation | Spacing, ineffective flow, levees, conveyance, energy |
| **Structure Check** | Bridge/Culvert/Weir | Section distances, flow types, loss coefficients |
| **Floodway Check** | Floodway Analysis | Surcharge limits, encroachment methods, discharge matching |
| **Profiles Check** | Profile Consistency | WSE ordering, discharge continuity, regime transitions |

## Running Individual Checks

You can run specific checks independently:

```python
from pathlib import Path
from ras_commander.check import RasCheck

# Get HDF paths
plan_hdf = Path("MyProject.p01.hdf")
geom_hdf = Path("MyProject.g01.hdf")

# Run NT check only (Manning's n and transitions)
nt_results = RasCheck.check_nt(geom_hdf)

# Run XS check (cross sections)
xs_results = RasCheck.check_xs(plan_hdf, geom_hdf, profiles=['100yr'])

# Run structure check
struct_results = RasCheck.check_structures(plan_hdf, geom_hdf, profiles=['100yr'])

# Run floodway check
fw_results = RasCheck.check_floodways(
    plan_hdf, geom_hdf,
    base_profile='100yr',
    floodway_profile='Floodway',
    surcharge=1.0
)

# Run profiles check
profiles_results = RasCheck.check_profiles(plan_hdf, profiles=['10yr', '50yr', '100yr'])
```

## Customizing Thresholds

RasCheck uses configurable thresholds that can be customized for project requirements:

```python
from ras_commander.check import get_default_thresholds, create_custom_thresholds

# Get default thresholds
thresholds = get_default_thresholds()

# View default Manning's n ranges
print(f"Overbank n range: {thresholds.mannings_n.overbank_min} - {thresholds.mannings_n.overbank_max}")
print(f"Channel n range: {thresholds.mannings_n.channel_min} - {thresholds.mannings_n.channel_max}")

# Create custom thresholds
custom = create_custom_thresholds({
    'mannings_n.overbank_max': 0.150,  # Stricter overbank maximum
    'floodway.surcharge_max_ft': 0.5,  # More restrictive surcharge (e.g., Minnesota)
})

# Run checks with custom thresholds
results = RasCheck.run_all("01", thresholds=custom, ras_object=ras)
```

### State-Specific Surcharge Limits

RasCheck includes built-in state-specific floodway surcharge limits:

```python
from ras_commander.check import get_state_surcharge_limit

# Get state-specific limits
print(get_state_surcharge_limit('TX'))  # 1.0 ft (FEMA default)
print(get_state_surcharge_limit('MN'))  # 0.5 ft (Minnesota)
print(get_state_surcharge_limit('NJ'))  # 0.2 ft (New Jersey)
print(get_state_surcharge_limit('IL'))  # 0.1 ft (Illinois)
print(get_state_surcharge_limit('WI'))  # 0.01 ft (Wisconsin - near zero rise)
```

## Working with Results

### Filtering Messages

```python
from ras_commander.check import Severity

# Filter by severity
errors = results.filter_by_severity(Severity.ERROR)
warnings = results.filter_by_severity(Severity.WARNING)

# Filter by check type
nt_messages = results.filter_by_check_type("NT")
xs_messages = results.filter_by_check_type("XS")

# Filter by station
station_msgs = results.filter_by_station("1500")
```

### Converting to DataFrame

```python
# Get all messages as DataFrame
df = results.to_dataframe()

# Group by check type
summary = df.groupby('check_type').size()
print(summary)

# Filter for specific message IDs
overbank_issues = df[df['message_id'].str.startswith('NT_RC')]
```

### Generating Reports

```python
from ras_commander.check import RasCheckReport, ReportMetadata

# Create metadata for report
metadata = ReportMetadata(
    project_name="Sample River Study",
    plan_name="Existing Conditions",
    profiles_checked=['10yr', '50yr', '100yr', 'Floodway'],
    base_flood_profile='100yr',
    floodway_profile='Floodway',
    surcharge_limit=1.0
)

# Generate HTML report
report = RasCheckReport(results, metadata)
report.generate_html("detailed_report.html")

# Export to CSV for further analysis
report.export_csv("messages.csv")

# Get summary statistics
summary = report.get_summary()
print(f"Passed: {summary['passed']}")
print(f"By check type: {summary['by_check_type']}")
```

## Message ID Format

RasCheck uses standardized message IDs following the original cHECk-RAS format:

```
{CHECK_TYPE}_{CATEGORY}_{NUMBER}{SUFFIX}
```

**Components:**

| Component | Values | Description |
|-----------|--------|-------------|
| CHECK_TYPE | NT, XS, BR, CU, IW, ST, FW, MP | Check category |
| CATEGORY | RC, TL, DT, IF, LV, SD, TF, etc. | Specific check subcategory |
| NUMBER | 01-99 | Message number within category |
| SUFFIX | L, R, C, S1-S4, etc. | Position indicator (optional) |

**Examples:**

- `NT_RC_01L` - Manning's n roughness check, left overbank
- `XS_IF_02R` - Cross section ineffective flow check, right side
- `BR_TF_04` - Bridge type flow check, pressure flow
- `FW_SC_01` - Floodway surcharge check

## Detailed Check Documentation

For comprehensive documentation of all validation checks and message IDs:

- [NT Check (Manning's n & Transitions)](quality-assurance/nt-check.md)
- [XS Check (Cross Sections)](quality-assurance/xs-check.md)
- [Structure Check (Bridges, Culverts, Weirs)](quality-assurance/structure-check.md)
- [Floodway Check](quality-assurance/floodway-check.md)
- [Profiles Check](quality-assurance/profiles-check.md)

## Comparison with FEMA cHECk-RAS

| Feature | FEMA cHECk-RAS | ras-commander RasCheck |
|---------|----------------|------------------------|
| Platform | Windows (.NET) | Cross-platform (Python) |
| HEC-RAS Version | 4.x (COM) | 6.x (HDF) |
| Flow Types | Steady only | Steady only |
| Data Access | Text files + COM | HDF5 directly |
| Report Format | HTML/PDF | HTML/CSV/DataFrame |
| Customization | Configuration file | Python API |
| Integration | Standalone | ras-commander library |

## Limitations

!!! note "Steady Flow Only"
    RasCheck currently supports **steady flow** models only. Unsteady flow validation
    is not implemented.

- Only validates HEC-RAS 6.x models with HDF output
- Requires computed plan results (not geometry-only)
- Some original cHECk-RAS features not yet implemented:
    - Interactive flagging/commenting through GUI
    - PDF report generation (use HTML or CSV export)
    - Access database storage

## References

- **cHECk-RAS User Guide** - Original FEMA cHECk-RAS documentation
- **HEC-RAS User's Manual** - U.S. Army Corps of Engineers
- **HEC-RAS Hydraulic Reference Manual** - Technical methodology
- **FEMA Guidelines and Standards for Flood Risk Analysis** - Regulatory requirements
- **44 CFR 60.3** - National Flood Insurance Program Regulations (floodway requirements)

## See Also

- [Example Notebook: RasCheck Validation](../notebooks/300_quality_assurance_rascheck.ipynb)
- [Steady Flow Analysis](steady-flow-analysis.md)
- [HDF Data Extraction](hdf-data-extraction.md)
