<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAS Commander Library Assistant</title>
    <!-- Link to Bootstrap CSS for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Include marked.js for markdown rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <style>
        /* Basic styling for the body */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f8f9fa; }
        /* Container styling for layout */
        .container { max-width: 1800px; margin: auto; width: 98%; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 8px; box-sizing: border-box; }
        /* Chat box styling */
        .chat-box { border: 1px solid #ced4da; padding: 10px; height: 400px; overflow-y: scroll; background-color: #ffffff; border-radius: 5px; }
        .message { margin: 10px 0; }
        .user { color: #0d6efd; }
        .assistant { color: #198754; }
        .error { color: red; }
        /* Button styling */
        .btn { padding: 10px 20px; background-color: #0d6efd; color: white; border: none; cursor: pointer; border-radius: 5px; }
        .btn:hover { background-color: #0b5ed7; }
        .cost { margin-top: 10px; font-weight: bold; }
        /* Copy button styling */
        .copy-btn {
            margin-left: 10px;
            padding: 5px 10px;
            background-color: #0d6efd;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        .copy-btn:hover {
            background-color: #0b5ed7;
        }
        .hidden { display: none; }
        /* Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            margin-top: 10px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0d6efd;
            cursor: pointer;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0d6efd;
            cursor: pointer;
        }
        /* File tree styling */
        #file-tree {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .file-tree-item {
            padding: 4px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        
        .file-tree-item:hover {
            background-color: #f0f0f0;
        }
        
        .file-tree-toggle {
            margin-right: 5px;
            width: 16px;
            height: 16px;
            text-align: center;
            line-height: 16px;
        }
        
        .file-tree-indent {
            margin-left: 20px;
        }
        
        .file-tree-selected {
            background-color: #e3f2fd;
        }

        /* Enhanced file tree container styling */
        .file-tree-container {
            width: 800px;
            flex-shrink: 0;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .file-tree-header {
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-tree {
            padding: 10px;
            max-height: 600px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
            width: 100%;
        }

        .file-item:hover {
            background-color: #f0f0f0;
        }

        .file-item.selected {
            background-color: #e3f2fd;
        }

        .file-icon {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }

        .folder-toggle {
            cursor: pointer;
            transition: transform 0.2s;
        }

        .folder-toggle.open {
            transform: rotate(90deg);
        }

        .file-children {
            margin-left: 20px;
        }

        /* Main container layout */
        .main-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            height: calc(100vh - 200px);
            min-height: 400px;
            width: 100%;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 400px;
        }

        .file-tree-header {
            padding: 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .file-tree {
            padding: 10px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .chat-box {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 10px;
            background-color: #ffffff;
            margin-bottom: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 1400px) {
            .file-tree-container {
                width: 600px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: auto;
            }
            
            .file-tree-container {
                width: 100%;
                height: 300px;
                margin-bottom: 20px;
            }
            
            .chat-container {
                width: 100%;
            }
        }

        /* Checkbox styling */
        .file-checkbox {
            margin-right: 8px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .file-item:hover {
            background-color: #f0f0f0;
        }

        .file-item.selected {
            background-color: #e3f2fd;
        }

        .file-icon {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }

        .file-item span {
            cursor: pointer;
        }

        .file-checkbox:indeterminate {
            background-color: #86b7fe;
            border-color: #86b7fe;
        }

        /* Folder toggle styling */
        .folder-toggle {
            display: inline-block;
            width: 16px;
            height: 16px;
            line-height: 14px;
            text-align: center;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
            font-size: 16px;
            color: #666;
            user-select: none;
        }

        .folder-toggle:hover {
            color: #000;
        }

        .file-icon {
            margin-right: 8px;
            width: 16px;
            text-align: center;
            cursor: pointer;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .file-children {
            margin-left: 0; /* Remove left margin since we're using padding */
        }

        /* Token count display styling */
        .token-count {
            margin-left: auto;
            color: #666;
            font-size: 0.85em;
            padding-left: 10px;
        }

        .total-tokens-display {
            padding: 10px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
            color: #0d6efd;
        }

        .refresh-icon {
            display: inline-block;
            transition: transform 0.5s;
        }
        
        .refresh-icon.spinning {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Advanced Settings Popover Styling */
        .advanced-settings-popover {
            min-width: 300px;
            padding: 10px;
        }

        .advanced-settings-popover .form-group {
            margin-bottom: 15px;
        }

        .advanced-settings-popover label {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .popover {
            max-width: 400px;
        }

        .popover-body {
            padding: 15px;
        }

        /* Add these new styles */
        .sticky-bottom {
            position: sticky;
            bottom: 0;
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
            z-index: 1000;
        }
        
        .file-tree-container {
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 250px);
        }
        
        .file-tree {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mt-4 mb-4">
            <h1>RAS Commander Library Assistant</h1>
            <button class="btn btn-outline-secondary" 
                    type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#settingsCollapse"
                    aria-expanded="false"
                    aria-controls="settingsCollapse">
                ‚öôÔ∏è Settings
            </button>
        </div>

        <!-- Settings collapse panel -->
        <div class="collapse mb-4" id="settingsCollapse">
            <div class="card">
                <div class="card-body">
                    <form id="settings-form">
                        <div class="form-group">
                            <label for="selected_model">Select Model:</label>
                            <select id="selected_model" name="selected_model" class="form-select" required>
                                <option value="" disabled>Select a model</option>
                                <option value="claude-3-5-sonnet-20240620" {% if settings.selected_model == 'claude-3-5-sonnet-20240620' %}selected{% endif %}>Claude 3.5 Sonnet (Anthropic)</option>
                                <option value="gpt-4o-2024-08-06" {% if settings.selected_model == 'gpt-4o-2024-08-06' %}selected{% endif %}>GPT-4o (OpenAI)</option>
                                <option value="gpt-4o-mini" {% if settings.selected_model == 'gpt-4o-mini' %}selected{% endif %}>GPT-4o-mini (OpenAI)</option>
                                <option value="o1-mini" {% if settings.selected_model == 'o1-mini' %}selected{% endif %}>o1-mini (OpenAI)</option>
                            </select>
                        </div>
                        <!-- API key input for Anthropic -->
                        <div id="anthropic_api_key_group" class="form-group hidden">
                            <label for="anthropic_api_key">Anthropic API Key:</label>
                            <input type="password" id="anthropic_api_key" name="anthropic_api_key" class="form-control" value="{{ settings.anthropic_api_key }}">
                        </div>
                        <!-- API key input for OpenAI -->
                        <div id="openai_api_key_group" class="form-group hidden">
                            <label for="openai_api_key">OpenAI API Key:</label>
                            <input type="password" id="openai_api_key" name="openai_api_key" class="form-control" value="{{ settings.openai_api_key }}">
                        </div>
                        <div class="form-group">
                            <label for="context_mode">Context Handling Mode:</label>
                            <select id="context_mode" name="context_mode" class="form-select" required>
                                <option value="" disabled>Select a mode</option>
                                <option value="full_context" {% if settings.context_mode == 'full_context' %}selected{% endif %}>Full Context</option>
                                <option value="rag" {% if settings.context_mode == 'rag' %}selected{% endif %}>Retrieval-Augmented Generation (RAG)</option>
                            </select>
                        </div>
                        <!-- RAG context size sliders -->
                        <div id="rag_sliders" class="hidden">
                            <div class="form-group">
                                <label for="initial_chunk_size">Initial RAG Context Size (tokens):</label>
                                <input type="range" id="initial_chunk_size" name="initial_chunk_size" min="16000" max="96000" step="1000" value="{{ settings.initial_chunk_size }}">
                                <span id="initial_chunk_size_value">{{ settings.initial_chunk_size }}</span>
                            </div>
                            <div class="form-group">
                                <label for="followup_chunk_size">Follow-up RAG Context Size (tokens):</label>
                                <input type="range" id="followup_chunk_size" name="followup_chunk_size" min="16000" max="64000" step="1000" value="{{ settings.followup_chunk_size }}">
                                <span id="followup_chunk_size_value">{{ settings.followup_chunk_size }}</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="card-footer text-end">
                    <button type="button" 
                            class="btn btn-secondary" 
                            id="advanced-settings-btn"
                            data-bs-toggle="popover" 
                            data-bs-placement="bottom" 
                            data-bs-html="true"
                            data-bs-title="Advanced Settings">
                        Advanced Settings
                    </button>
                </div>
            </div>
        </div>
        
        <div class="main-container">
            <!-- File Tree Container -->
            <div id="file-tree-container" class="file-tree-container" style="display: none;">
                <div class="file-tree-header">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <h5 class="mb-0">Project Files</h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-primary" id="refresh-context">
                                <span class="refresh-icon">‚Üª</span> Refresh Context
                            </button>
                        </div>
                    </div>
                    <div id="refresh-status" class="text-muted small mt-1" style="display: none;"></div>
                    <div id="refresh-error" class="alert alert-danger small mt-1" style="display: none;"></div>
                </div>
                <div class="file-tree" id="file-tree"></div>
                
                <!-- Cost Estimation Panel -->
                <div class="p-3 bg-gray-100 rounded border sticky-bottom">
                    <div class="mb-2 border-bottom pb-2">
                        <div class="d-flex justify-content-between">
                            <span>Selected Files:</span>
                            <strong id="selected-files-count">0 files</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Selected Tokens:</span>
                            <strong id="selected-tokens-count">0</strong>
                        </div>
                    </div>
                    <div>
                        <div class="fw-bold mb-1">Estimated Context Costs:</div>
                        <div class="d-flex justify-content-between">
                            <span>Claude 3.5:</span>
                            <strong id="claude-cost">$0.0000</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>GPT-4:</span>
                            <strong id="gpt4-cost">$0.0000</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>GPT-4 Mini:</span>
                            <strong id="gpt4-mini-cost">$0.0000</strong>
                        </div>
                        <div class="mt-2 pt-2 border-top">
                            <div class="d-flex justify-content-between text-muted">
                                <small>Current Conversation:</small>
                                <small id="conversation-tokens">0 tokens</small>
                            </div>
                            <div class="d-flex justify-content-between text-muted">
                                <small>Message Being Typed:</small>
                                <small id="current-message-tokens">0 tokens</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            

            
            <!-- Chat Container -->
            <div class="chat-container">
                <!-- Add header similar to file tree -->
                <div class="file-tree-header">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <h5 class="mb-0">Chat Window</h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-primary" id="reset-chat">
                                Reset Conversation
                            </button>
                        </div>
                    </div>
                </div>
                <div class="chat-box" id="chat-box"></div>
                <form id="chat-form" class="mt-3">
                    <div class="form-group">
                        <label for="user-input">Your message:</label>
                        <textarea id="user-input" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="mt-2 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <button type="submit" class="btn btn-primary">Send</button>
                            <div id="cost-display" class="text-muted"></div>
                        </div>
                        <button type="button" onclick="saveConversation()" class="btn btn-outline-secondary btn-sm">
                            Save Conversation
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Include Bootstrap JS for functionality -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // FileTreeViewer class to manage the file tree display and interactions
        class FileTreeViewer {
            constructor(container) {
                this.container = container; // Container for the file tree
                this.selectedFiles = new Set(); // Set to track selected files
                this.onSelectionChange = null; // Callback for selection changes
                this.totalTokensDisplay = document.createElement('div'); // Display for total tokens
                this.totalTokensDisplay.className = 'total-tokens-display';
                container.parentElement.insertBefore(this.totalTokensDisplay, container); // Insert total tokens display before the container
                this.expandedFolders = [
                    'ras-commander',           // Root project folder
                    'ras-commander/examples',  // Examples folder
                    'ras-commander/ras_commander'  // Main package folder
                ];
            }

            // Update the total tokens display based on selected files
            updateTotalTokens() {
                let totalTokens = 0; // Initialize total tokens
                this.selectedFiles.forEach(path => {
                    const element = this.container.querySelector(`[data-path="${path}"]`); // Find the file element
                    if (element) {
                        totalTokens += parseInt(element.dataset.tokens || 0); // Add tokens from the selected file
                    }
                });
                this.totalTokensDisplay.textContent = `Selected: ${totalTokens.toLocaleString()} tokens`; // Update display
            }

            // Render a node (file or directory) in the file tree
            renderNode(node, level = 0) {
                const item = document.createElement('div'); // Create a new div for the item
                item.className = 'file-item'; // Set class for styling
                item.style.paddingLeft = `${level * 20}px`; // Indent based on level
                item.dataset.path = node.path; // Store the path in a data attribute
                item.dataset.tokens = node.tokens; // Store the token count in a data attribute
                
                const checkbox = document.createElement('input'); // Create a checkbox for selection
                checkbox.type = 'checkbox';
                checkbox.className = 'file-checkbox me-2'; // Add class for styling
                
                if (node.type === 'directory') {
                    // Directory rendering
                    const toggleBtn = document.createElement('span'); // Button to toggle folder open/close
                    toggleBtn.className = 'folder-toggle me-2';
                    
                    const icon = document.createElement('span'); // Icon for folder
                    icon.className = 'file-icon';
                    
                    const nameSpan = document.createElement('span'); // Name of the file or folder
                    nameSpan.textContent = node.name;
                    
                    const tokenCount = document.createElement('span'); // Display token count
                    tokenCount.className = 'token-count';
                    tokenCount.textContent = `${node.tokens.toLocaleString()} tokens`;
                    
                    // Append elements to the item
                    item.appendChild(toggleBtn);
                    item.appendChild(checkbox);
                    item.appendChild(icon);
                    item.appendChild(nameSpan);
                    item.appendChild(tokenCount);
                    
                    const content = document.createElement('div'); // Container for child items
                    content.className = 'file-children';
                    
                    // Check if this folder should be expanded by default
                    const shouldExpand = this.expandedFolders.some(path => {
                        const normalizedPath = path.replace(/\\/g, '/');
                        const nodePath = node.path.replace(/\\/g, '/');
                        return normalizedPath === nodePath || normalizedPath.startsWith(nodePath + '/');
                    });
                    
                    content.style.display = shouldExpand ? 'block' : 'none'; // Set display based on expansion
                    toggleBtn.textContent = shouldExpand ? '‚àí' : '+'; // Set toggle button text
                    icon.textContent = shouldExpand ? 'üìÇ' : 'üìÅ'; // Set icon based on expansion
                    
                    // Function to handle expand/collapse
                    const toggleFolder = (e) => {
                        e.stopPropagation(); // Prevent event bubbling
                        const isExpanded = content.style.display !== 'none'; // Check if currently expanded
                        content.style.display = isExpanded ? 'none' : 'block'; // Toggle display
                        toggleBtn.textContent = isExpanded ? '+' : '‚àí'; // Update toggle button text
                        icon.textContent = isExpanded ? 'üìÅ' : 'üìÇ'; // Update icon
                    };
                    
                    // Add click handlers for toggle button, icon, and name
                    toggleBtn.onclick = toggleFolder;
                    icon.onclick = toggleFolder;
                    nameSpan.onclick = toggleFolder;
                    
                    // Handle directory checkbox click
                    checkbox.onclick = (e) => {
                        e.stopPropagation(); // Prevent event bubbling
                        this.toggleDirectory(node, checkbox.checked, content); // Toggle directory selection
                    };
                    
                    // Render child nodes if they exist
                    if (node.children) {
                        node.children.forEach(child => {
                            const childElement = this.renderNode(child, level + 1); // Render child node
                            content.appendChild(childElement); // Append child to content
                        });
                    }
                    
                    const container = document.createElement('div'); // Create a container for the item and its children
                    container.appendChild(item);
                    container.appendChild(content);
                    return container; // Return the complete node structure
                    
                } else {
                    // File rendering
                    const emptyToggle = document.createElement('span'); // Placeholder for folder toggle
                    emptyToggle.className = 'folder-toggle me-2';
                    emptyToggle.style.visibility = 'hidden'; // Hide placeholder
                    
                    const icon = document.createElement('span'); // Icon for file
                    icon.className = 'file-icon';
                    icon.textContent = 'üìÑ'; // File icon
                    
                    const nameSpan = document.createElement('span'); // Name of the file
                    nameSpan.textContent = node.name;
                    
                    const tokenCount = document.createElement('span'); // Display token count
                    tokenCount.className = 'token-count';
                    tokenCount.textContent = `${node.tokens.toLocaleString()} tokens`;
                    
                    checkbox.checked = this.selectedFiles.has(node.path); // Check if file is selected
                    
                    // Append elements to the item
                    item.appendChild(emptyToggle);
                    item.appendChild(checkbox);
                    item.appendChild(icon);
                    item.appendChild(nameSpan);
                    item.appendChild(tokenCount);
                    
                    // Update checkbox handler to include token counting
                    checkbox.onclick = (e) => {
                        e.stopPropagation(); // Prevent event bubbling
                        if (checkbox.checked) {
                            this.selectedFiles.add(node.path); // Add file to selected set
                        } else {
                            this.selectedFiles.delete(node.path); // Remove file from selected set
                        }
                        
                        if (this.onSelectionChange) {
                            this.onSelectionChange(Array.from(this.selectedFiles)); // Call selection change callback
                        }
                        
                        this.updateParentCheckboxes(item); // Update parent checkboxes
                        this.updateTotalTokens(); // Update total tokens display
                    };
                    
                    // Handle file name click (view content)
                    const viewContent = async (e) => {
                        e.stopPropagation(); // Prevent event bubbling
                        
                        const selected = document.querySelector('.file-tree-selected'); // Find currently selected item
                        if (selected) {
                            selected.classList.remove('file-tree-selected'); // Remove selection from previous item
                        }
                        
                        item.classList.add('file-tree-selected'); // Mark this item as selected
                        
                        try {
                            const response = await fetch(`/get_file_content?path=${encodeURIComponent(node.path)}`); // Fetch file content
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`); // Handle HTTP errors
                            }
                            const data = await response.json(); // Parse JSON response
                            
                            const userInput = document.getElementById('user-input'); // Get user input textarea
                            userInput.value = `Please help me with this file:\n\n${data.content}`; // Populate input with file content
                        } catch (error) {
                            console.error('Error loading file content:', error); // Log error
                            alert('Error loading file content: ' + error.message); // Alert user
                        }
                    };
                    
                    // Add click handlers for both icon and name
                    icon.onclick = viewContent;
                    nameSpan.onclick = viewContent;
                    
                    return item; // Return the file item
                }
            }

            // Toggle selection for a directory and its children
            toggleDirectory(node, checked, contentElement) {
                const checkboxes = contentElement.querySelectorAll('.file-checkbox'); // Get all checkboxes in the directory
                checkboxes.forEach(checkbox => {
                    checkbox.checked = checked; // Set checkbox state
                    
                    const fileItem = checkbox.closest('.file-item'); // Find the closest file item
                    const nameSpan = fileItem.querySelector('span:not(.file-icon):not(.token-count)'); // Get the name span
                    const path = this.getNodePath(node, nameSpan.textContent); // Get the full path
                    
                    if (checked) {
                        this.selectedFiles.add(path); // Add path to selected files
                    } else {
                        this.selectedFiles.delete(path); // Remove path from selected files
                    }
                });

                if (this.onSelectionChange) {
                    this.onSelectionChange(Array.from(this.selectedFiles)); // Call selection change callback
                }
                
                this.updateTotalTokens(); // Update total tokens display
            }

            // Construct the full path for a file within a directory
            getNodePath(node, fileName) {
                return node.path + '/' + fileName; // Return full path
            }

            // Update parent directory checkboxes based on child selections
            updateParentCheckboxes(element) {
                let parent = element.parentElement; // Start with the parent element
                while (parent) {
                    const parentCheckbox = parent.querySelector(':scope > .file-item > .file-checkbox'); // Find the parent checkbox
                    if (parentCheckbox) {
                        const childCheckboxes = parent.querySelectorAll('.file-children .file-checkbox'); // Get all child checkboxes
                        const allChecked = Array.from(childCheckboxes).every(cb => cb.checked); // Check if all are checked
                        const someChecked = Array.from(childCheckboxes).some(cb => cb.checked); // Check if some are checked
                        
                        parentCheckbox.checked = allChecked; // Set parent checkbox state
                        parentCheckbox.indeterminate = someChecked && !allChecked; // Set indeterminate state if some are checked
                    }
                    parent = parent.parentElement; // Move up to the next parent
                }
            }

            // Initialize the file tree with data
            initialize(data) {
                this.container.innerHTML = ''; // Clear existing content
                if (data) {
                    const rootElement = this.renderNode(data); // Render the root node
                    this.container.appendChild(rootElement); // Append the root element to the container
                }
            }

            // Get the currently selected files
            getSelectedFiles() {
                return Array.from(this.selectedFiles); // Return selected files as an array
            }

            async loadProcessedFiles() {
                try {
                    const response = await fetch('/get_file_tree');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    // Clear current selection
                    this.selectedFiles.clear();
                    
                    // Reinitialize with new data
                    this.initialize(data.fileTree);
                    
                    // Update total tokens display
                    this.updateTotalTokens();
                    
                } catch (error) {
                    console.error('Error loading processed files:', error);
                    throw error;
                }
            }
        }

        // Wait for the DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            const selectedModel = document.getElementById('selected_model'); // Model selection dropdown
            const anthropicGroup = document.getElementById('anthropic_api_key_group'); // Anthropic API key input group
            const openaiGroup = document.getElementById('openai_api_key_group'); // OpenAI API key input group
            const contextMode = document.getElementById('context_mode'); // Context mode selection dropdown
            const fileTreeContainer = document.getElementById('file-tree-container'); // File tree container
            const fileTree = document.getElementById('file-tree'); // File tree element
            const chatContainer = document.querySelector('.chat-container'); // Chat container
            const ragSliders = document.getElementById('rag_sliders'); // RAG sliders container

            // Initialize file tree viewer
            const fileTreeViewer = new FileTreeViewer(fileTree); // Ensure this is defined before use

            // Load the file tree from the server
            async function loadFileTree() {
                try {
                    const response = await fetch('/get_file_tree'); // Fetch file tree data
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`); // Handle HTTP errors
                    }
                    const data = await response.json(); // Parse JSON response
                    fileTreeViewer.initialize(data.fileTree); // Initialize file tree viewer with data
                } catch (error) {
                    console.error('Error loading file tree:', error); // Log error
                    alert('Error loading file tree: ' + error.message); // Alert user
                }
            }

            // Toggle the visibility of the file tree based on context mode
            function toggleFileTree() {
                if (contextMode.value === 'full_context') {
                    fileTreeContainer.style.display = 'flex'; // Show file tree
                    loadFileTree(); // Load file tree data
                } else {
                    fileTreeContainer.style.display = 'none'; // Hide file tree
                }
            }

            // Toggle visibility of API key input fields based on selected model
            function toggleApiKeys() {
                const model = selectedModel.value; // Get selected model
                if (model.startsWith('claude')) {
                    anthropicGroup.classList.remove('hidden'); // Show Anthropic API key input
                    openaiGroup.classList.add('hidden'); // Hide OpenAI API key input
                } else if (model.startsWith('gpt') || model.startsWith('o1')) {
                    openaiGroup.classList.remove('hidden'); // Show OpenAI API key input
                    anthropicGroup.classList.add('hidden'); // Hide Anthropic API key input
                } else {
                    anthropicGroup.classList.add('hidden'); // Hide both API key inputs
                    openaiGroup.classList.add('hidden');
                }
            }

            // Toggle visibility of RAG sliders based on context mode
            function toggleRagSliders() {
                if (contextMode.value === 'rag') {
                    ragSliders.classList.remove('hidden'); // Show RAG sliders
                } else {
                    ragSliders.classList.add('hidden'); // Hide RAG sliders
                }
            }

            // Add event listeners for context mode and model selection changes
            contextMode.addEventListener('change', () => {
                toggleFileTree(); // Toggle file tree visibility
                toggleRagSliders(); // Toggle RAG sliders visibility
                autoSaveSettings(); // Auto-save settings
            });

            selectedModel.addEventListener('change', () => {
                toggleApiKeys(); // Toggle API key visibility
                autoSaveSettings(); // Auto-save settings
            });

            // Initialize UI state
            toggleApiKeys(); // Set initial API key visibility
            toggleRagSliders(); // Set initial RAG sliders visibility

            // Force initial file tree display if in full_context mode
            if (contextMode.value === 'full_context') {
                fileTreeContainer.style.display = 'flex'; // Show file tree
                loadFileTree(); // Load file tree data
            }

            // Handle chat form submission
            const chatForm = document.getElementById('chat-form'); // Chat form element
            const chatBox = document.getElementById('chat-box'); // Chat box element
            const userInput = document.getElementById('user-input'); // User input textarea
            const costDisplay = document.getElementById('cost-display'); // Cost display element

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault(); // Prevent default form submission
                const message = userInput.value.trim(); // Get user input
                if (message === '') return; // Do nothing if input is empty

                // Get selected files if in full_context mode
                const selectedFiles = contextMode.value === 'full_context' ? 
                    fileTreeViewer.getSelectedFiles() : []; // Get selected files

                // Display user message with markdown rendering
                const userMessage = document.createElement('div'); // Create user message element
                userMessage.className = 'message user'; // Set class for styling
                userMessage.innerHTML = 'User: ' + marked.parse(message); // Render message as markdown
                chatBox.appendChild(userMessage); // Append user message to chat box

                // Clear input
                userInput.value = ''; // Reset user input

                // Create assistant message container
                const assistantMessage = document.createElement('div'); // Create assistant message element
                assistantMessage.className = 'message assistant'; // Set class for styling
                assistantMessage.innerHTML = 'Assistant: '; // Initial assistant message
                const responseText = document.createElement('span'); // Span for response text
                assistantMessage.appendChild(responseText); // Append response text to assistant message
                chatBox.appendChild(assistantMessage); // Append assistant message to chat box

                // Scroll to bottom
                chatBox.scrollTop = chatBox.scrollHeight; // Scroll to the bottom of the chat box

                try {
                    const response = await fetch('/chat', { // Send chat message to server
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json', // Set content type
                            'Accept': 'text/event-stream', // Accept server-sent events
                        },
                        body: JSON.stringify({ 
                            message: message, // Send user message
                            selectedFiles: selectedFiles // Send selected files
                        })
                    });

                    const reader = response.body.getReader(); // Get reader for response body
                    const decoder = new TextDecoder(); // Create a text decoder
                    let buffer = ''; // Buffer for accumulating response
                    let fullResponse = ''; // Full response text

                    while (true) {
                        const {value, done} = await reader.read(); // Read from response
                        if (done) break; // Exit loop if done
                        
                        buffer += decoder.decode(value, {stream: true}); // Decode and accumulate response
                        const lines = buffer.split('\n'); // Split buffer into lines
                        
                        // Process all complete lines
                        buffer = lines.pop() || '';  // Keep any incomplete line in the buffer
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) { // Check for data lines
                                try {
                                    const data = JSON.parse(line.slice(6)); // Parse JSON data
                                    
                                    if (data.chunk) {
                                        // Accumulate the complete response
                                        fullResponse += data.chunk; // Append chunk to full response
                                        // Render the accumulated response
                                        responseText.innerHTML = marked.parse(fullResponse); // Update response text
                                    } else if (data.cost) {
                                        costDisplay.textContent = `Estimated Cost: $${data.cost.toFixed(6)} (${data.provider})`; // Display cost
                                        
                                        // Add copy button after streaming is complete
                                        const copyButton = document.createElement('button'); // Create copy button
                                        copyButton.textContent = 'Copy Response'; // Set button text
                                        copyButton.className = 'copy-btn btn btn-sm'; // Set class for styling
                                        copyButton.onclick = () => copyToClipboard(fullResponse); // Set click handler
                                        assistantMessage.appendChild(copyButton); // Append copy button to assistant message
                                    } else if (data.error) {
                                        const errorDiv = document.createElement('div'); // Create error message element
                                        errorDiv.className = 'error'; // Set class for styling
                                        errorDiv.textContent = data.error; // Set error message
                                        assistantMessage.appendChild(errorDiv); // Append error message to assistant
                                    }
                                    
                                    // Scroll to bottom as content is added
                                    chatBox.scrollTop = chatBox.scrollHeight; // Scroll to the bottom
                                } catch (e) {
                                    console.error('Error parsing SSE data:', e); // Log parsing error
                                }
                            }
                        }
                    }

                } catch (error) {
                    console.error('Error:', error); // Log error
                    const errorMessage = document.createElement('div'); // Create error message element
                    errorMessage.className = 'message assistant error'; // Set class for styling
                    errorMessage.textContent = 'Error: ' + error.message; // Set error message
                    chatBox.appendChild(errorMessage); // Append error message to chat box
                    chatBox.scrollTop = chatBox.scrollHeight; // Scroll to the bottom
                }
            });

            // Function to copy text to clipboard
            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('Response copied to clipboard!'); // Alert user on success
                }, (err) => {
                    console.error('Could not copy text: ', err); // Log error
                });
            }

            // Function to auto-save settings
            function autoSaveSettings() {
                const formData = new FormData(document.getElementById('settings-form')); // Get form data
                fetch('/submit', {
                    method: 'POST',
                    body: formData // Send form data to server
                })
                .then(response => response.json()) // Parse JSON response
                .then(data => {
                    console.log('Settings saved:', data); // Log success
                })
                .catch(error => {
                    console.error('Error saving settings:', error); // Log error
                });
            }

            const refreshBtn = document.getElementById('refresh-context');
            const refreshIcon = refreshBtn.querySelector('.refresh-icon');
            const refreshStatus = document.getElementById('refresh-status');
            const refreshError = document.getElementById('refresh-error');
            
            async function refreshContext() {
                refreshBtn.disabled = true;
                refreshIcon.classList.add('spinning');
                refreshError.style.display = 'none';
                refreshStatus.style.display = 'none';
                
                try {
                    const response = await fetch('/refresh_context', {
                        method: 'POST'
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Failed to refresh context: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    // Show success status
                    refreshStatus.textContent = `Last refreshed: ${new Date().toLocaleTimeString()}`;
                    refreshStatus.style.display = 'block';
                    
                    // Reload file tree if it exists
                    if (fileTreeViewer) {
                        await fileTreeViewer.loadProcessedFiles();
                    }
                    
                } catch (error) {
                    console.error('Error refreshing context:', error);
                    refreshError.textContent = error.message;
                    refreshError.style.display = 'block';
                } finally {
                    refreshBtn.disabled = false;
                    refreshIcon.classList.remove('spinning');
                }
            }
            
            // Add click handler for refresh button
            refreshBtn.addEventListener('click', refreshContext);

            const resetChatBtn = document.getElementById('reset-chat');
            resetChatBtn.addEventListener('click', () => {
                if (confirm('Are you sure you want to reset the conversation? This cannot be undone.')) {
                    chatBox.innerHTML = ''; // Clear chat history
                    // You may also want to send a request to the server to clear the conversation state
                    fetch('/reset_conversation', { method: 'POST' })
                        .catch(error => console.error('Error resetting conversation:', error));
                }
            });

            // Initialize popover for advanced settings
            const advancedSettingsBtn = document.getElementById('advanced-settings-btn');
            const advancedSettingsContent = `
                <div class="advanced-settings-popover">
                    <div class="form-group mb-3">
                        <label for="temperature">Temperature:</label>
                        <input type="range" class="form-range" id="temperature" min="0" max="1" step="0.1" value="0.7">
                        <span id="temperature-value">0.7</span>
                    </div>
                    <div class="form-group mb-3">
                        <label for="max-tokens">Max Tokens:</label>
                        <input type="number" class="form-control" id="max-tokens" value="2000" min="100" max="4000">
                    </div>
                    <div class="form-group">
                        <label for="system-prompt">System Prompt:</label>
                        <textarea class="form-control" id="system-prompt" rows="3"></textarea>
                    </div>
                </div>
            `;

            // Initialize the popover
            const popover = new bootstrap.Popover(advancedSettingsBtn, {
                content: advancedSettingsContent,
                trigger: 'click',
                sanitize: false
            });

            // Handle popover shown event to initialize range input display
            advancedSettingsBtn.addEventListener('shown.bs.popover', () => {
                const temperatureInput = document.getElementById('temperature');
                const temperatureValue = document.getElementById('temperature-value');
                
                if (temperatureInput && temperatureValue) {
                    temperatureInput.addEventListener('input', () => {
                        temperatureValue.textContent = temperatureInput.value;
                    });
                }
            });

            // Close popover when clicking outside
            document.addEventListener('click', (event) => {
                if (!event.target.closest('#advanced-settings-btn') && 
                    !event.target.closest('.popover')) {
                    popover.hide();
                }
            });

            // Set selection change callback for file tree viewer
            fileTreeViewer.setSelectionChangeCallback((selectedFiles) => {
                const selectedStats = fileTreeViewer.getSelectedStats(); // Get selected stats
                updateContextCostDisplay(selectedStats); // Update cost display
            });
        });

        // Function to save conversation history
        function saveConversation() {
            fetch('/save_conversation', {
                method: 'POST' // Send request to save conversation
            })
            .then(response => {
                if (response.ok) {
                    return response.blob(); // Return response as blob
                } else {
                    throw new Error('Failed to save conversation history.'); // Handle error
                }
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob); // Create URL for blob
                const a = document.createElement('a'); // Create anchor element
                a.style.display = 'none'; // Hide anchor
                a.href = url; // Set href to blob URL
                a.download = 'conversation_history.txt'; // Set download filename
                document.body.appendChild(a); // Append anchor to body
                a.click(); // Trigger download
                window.URL.revokeObjectURL(url); // Clean up URL
            })
            .catch(error => {
                console.error('Error:', error); // Log error
                alert(error.message); // Alert user
            });
        }

        // Function to update context cost display
        function updateContextCostDisplay(selectedStats) {
            const costDisplay = document.getElementById('context-cost-display'); // Get cost display element
            const costsSpan = document.getElementById('context-costs'); // Get costs span
            
            if (selectedStats.totalTokens > 0) {
                costsSpan.innerHTML = `
                    <div class="mt-1">
                        <div>Tokens: ${selectedStats.totalTokens.toLocaleString()}</div>
                        <div>Claude 3.5: $${selectedStats.costs.claude.toFixed(4)}</div>
                        <div>GPT-4: $${selectedStats.costs.gpt4.toFixed(4)}</div>
                        <div>GPT-4 Mini: $${selectedStats.costs.gpt4mini.toFixed(4)}</div>
                    </div>
                `;
                costDisplay.style.display = 'block'; // Show cost display
            } else {
                costDisplay.style.display = 'none'; // Hide cost display
            }
        }
    </script>
</body>
</html>